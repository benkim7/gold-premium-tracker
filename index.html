<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì ê¸°</title>
  <!-- Chart.js & time adapter & zoom plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; text-align: center; margin: 20px; background-color: #fafafa; }
    #chart-container { width: 100%; height: 60vh; margin-bottom: 40px; }
    #fx-chart-container { width: 100%; height: 40vh; margin-bottom: 20px; }
    canvas { width: 100%; height: 100%; }
    #footer { font-size: 11px; color: gray; position: fixed; bottom: 8px; right: 10px; }
  </style>
</head>

<body>
  <h1>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì´</h1>
  <div id="data"></div>

  <div id="chart-container"><canvas id="chart"></canvas></div>
  <div id="fx-chart-container"><canvas id="fxChart"></canvas></div>

  <div id="footer">
    ğŸ“Š ë°ì´í„° ì¶œì²˜:
    <a href="https://metals-api.com" target="_blank">Metals API (êµ­ì œ ê¸ˆ)</a>,
    <a href="https://open.er-api.com" target="_blank">Open ER API (í™˜ìœ¨)</a>,
    <a href="https://apiportal.koreainvestment.com" target="_blank">í•œêµ­íˆ¬ìì¦ê¶Œ (êµ­ë‚´ ê¸ˆ)</a>
  </div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://ozatkbrmvkhejrbymrvd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96YXRrYnJtdmtoZWpyYnltcnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDMxNTUsImV4cCI6MjA3NTIxOTE1NX0.vxq7FyffhNJwMzoV1c8b6lI25n39X6Tud2oTAiICM5w"
);

const METALS_KEY = "6w0ly66tw8li4g0hp72mzukci0p1qnheg4o8t3wby5qprrkw3u8rd9lj5gyu";
let chart, fxChart;

function fmtUSD(x) {
  return Number(x).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtKRW(x) {
  return Number(x).toLocaleString('ko-KR');
}

async function fetchGoldPrices() {
  try {
    // 1) êµ­ì œ ê¸ˆ (USD/oz)
    const mResp = await fetch(`https://metals-api.com/api/latest?access_key=${METALS_KEY}&base=USD&symbols=XAU`);
    const mJson = await mResp.json();
    if (!mJson.success) throw new Error("Metals API ì˜¤ë¥˜: " + JSON.stringify(mJson));
    const intlPriceUSD = 1 / mJson.rates.XAU;

    // 2) í™˜ìœ¨ USDâ†’KRW
    const fxResp = await fetch("https://open.er-api.com/v6/latest/USD");
    const fxJson = await fxResp.json();
    const usdToKrw = fxJson?.rates?.KRW ?? fxJson?.conversion_rates?.KRW;
    if (typeof usdToKrw !== "number") throw new Error("í™˜ìœ¨ ì‘ë‹µ ì˜¤ë¥˜");

    const intlPriceKRW = intlPriceUSD * usdToKrw;

    // 3) êµ­ë‚´ ê¸ˆ (KIS í”„ë¡ì‹œ) â€” oz ê¸°ì¤€
    let korPriceKRWPerOz = intlPriceKRW;
    try {
      const kisResp = await fetch("/api/kis-goldprice");
      const kisJson = await kisResp.json();
      if (kisResp.ok && kisJson?.ok && kisJson.priceKRWPerOz > 0) {
        korPriceKRWPerOz = kisJson.priceKRWPerOz;
      } else {
        // íœ´ì¥/ë°ì´í„° ì—†ìŒ â†’ êµ­ì œ ê¸ˆìœ¼ë¡œ ëŒ€ì²´
        korPriceKRWPerOz = intlPriceKRW;
      }
    } catch (e) {
      korPriceKRWPerOz = intlPriceKRW;
    }

    // 4) í”„ë¦¬ë¯¸ì—„
    const premium = ((korPriceKRWPerOz - intlPriceKRW) / intlPriceKRW) * 100;
    const marketStatus = (korPriceKRWPerOz === intlPriceKRW) ? "ğŸ”´ íœ´ì¥ì¤‘" : "ğŸŸ¢ ê±°ë˜ì¤‘";

    // 5) ìƒë‹¨ ì •ë³´ í‘œì‹œ (USD ì²œë‹¨ìœ„ ì½¤ë§ˆ ì ìš©)
    document.getElementById("data").innerHTML = `
      <p>êµ­ì œ ê¸ˆ (USD/oz): ${fmtUSD(intlPriceUSD)}</p>
      <p>êµ­ì œ ê¸ˆ (KRW/oz): ${fmtKRW(intlPriceKRW)}</p>
      <p>êµ­ë‚´ ê¸ˆ (KRW/oz): ${fmtKRW(korPriceKRWPerOz)}</p>
      <p>í˜„ì¬ í™˜ìœ¨: ${fmtKRW(usdToKrw)} KRW/USD</p>
      <p>ì‹œì¥ ìƒíƒœ: <strong>${marketStatus}</strong></p>
      <h2>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„: ${fmtUSD(premium)}%</h2>
    `;

    // 6) DB ì €ì¥
    await supabase.from("gold_prices").insert([
      {
        intl_price_usd: intlPriceUSD,
        intl_price_krw: intlPriceKRW,
        kor_price_krw: korPriceKRWPerOz,
        usd_to_krw: usdToKrw,
        premium,
      },
    ]);

    // 7) ì°¨íŠ¸ ë Œë”
    await renderGoldChart();
    await renderFxChart();
  } catch (err) {
    console.error("fetchGoldPrices error:", err);
  }
}

// âœ… ì „ì²´ ë°ì´í„°ëŠ” ëª¨ë‘ ë¡œë“œí•˜ê³ ,
//    xì¶•ì˜ min/max ë¡œ â€œê¸°ë³¸ ë³´ê¸°=ìµœê·¼ 1ì‹œê°„â€ë§Œ ë³´ì—¬ì¤Œ.
//    â†’ ì¤Œì¸ í›„ **ì¢Œìš° ë“œë˜ê·¸(pan)** ë¡œ ê³¼ê±° ë°ì´í„° íƒìƒ‰ ê°€ëŠ¥.
async function renderGoldChart() {
  const { data } = await supabase
    .from("gold_prices")
    .select("created_at,intl_price_krw,kor_price_krw,premium")
    .order("created_at", { ascending: true });
  if (!data || data.length === 0) return;

  const pointsIntl = data.map(r => ({ x: new Date(r.created_at), y: r.intl_price_krw }));
  const pointsKor  = data.map(r => ({ x: new Date(r.created_at), y: r.kor_price_krw }));
  const pointsPrem = data.map(r => ({ x: new Date(r.created_at), y: r.premium }));

  const now = Date.now();
  const oneHourAgo = now - 60 * 60 * 1000;

  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    data: {
      datasets: [
        { type: "bar", label: "êµ­ì œ ê¸ˆ (KRW/oz)", data: pointsIntl, backgroundColor: "rgba(255, 215, 0, 0.5)", yAxisID: "y1" },
        { type: "bar", label: "êµ­ë‚´ ê¸ˆ (KRW/oz)", data: pointsKor,  backgroundColor: "rgba(30, 144, 255, 0.4)", yAxisID: "y1" },
        { type: "line", label: "ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ (%)", data: pointsPrem, borderColor: "red", borderWidth: 2, fill: false, yAxisID: "y2" },
      ],
    },
    options: {
      parsing: false, // {x,y} í˜•íƒœ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: {
          type: "time",
          time: { unit: "minute", displayFormats: { minute: "HH:mm" } },
          min: oneHourAgo,  // âœ… ê¸°ë³¸ ë³´ê¸°: ìµœê·¼ 1ì‹œê°„
          max: now,
          title: { display: true, text: "ì‹œê°„" },
        },
        y1: { position: "left", title: { display: true, text: "ê¸ˆê°€ê²© (KRW/oz)" } },
        y2: { position: "right", title: { display: true, text: "í”„ë¦¬ë¯¸ì—„ (%)" }, grid: { drawOnChartArea: false } },
      },
      plugins: {
        legend: { position: "bottom" },
        zoom: {
          pan: {
            enabled: true,     // âœ… ë“œë˜ê·¸í•´ì„œ ì¢Œìš° ìŠ¤í¬ë¡¤
            mode: "x",
            overScaleMode: "x" // xì¶• ìš°ì„  íŒ¬
          },
          zoom: {
            wheel: { enabled: true }, // íœ ë¡œ ì¤Œì¸/ì•„ì›ƒ
            pinch: { enabled: true }, // ëª¨ë°”ì¼ í•€ì¹˜ ì¤Œ
            mode: "x",
          },
        },
      },
    },
  });
}

async function renderFxChart() {
  const { data } = await supabase
    .from("gold_prices")
    .select("created_at,usd_to_krw")
    .order("created_at", { ascending: true });
  if (!data || data.length === 0) return;

  const pointsFx = data.map(r => ({ x: new Date(r.created_at), y: r.usd_to_krw }));

  const now = Date.now();
  const oneHourAgo = now - 60 * 60 * 1000;

  const ctx = document.getElementById("fxChart").getContext("2d");
  if (fxChart) fxChart.destroy();

  fxChart = new Chart(ctx, {
    type: "line",
    data: { datasets: [{ label: "USD â†’ KRW í™˜ìœ¨", data: pointsFx, borderColor: "blue", borderWidth: 2, fill: false }] },
    options: {
      parsing: false,
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: {
          type: "time",
          time: { unit: "minute", displayFormats: { minute: "HH:mm" } },
          min: oneHourAgo,   // âœ… ê¸°ë³¸ ë³´ê¸°: ìµœê·¼ 1ì‹œê°„
          max: now,
          title: { display: true, text: "ì‹œê°„" },
        },
        y: { beginAtZero: false, title: { display: true, text: "í™˜ìœ¨ (KRW/USD)" } },
      },
      plugins: {
        legend: { position: "bottom" },
        zoom: {
          pan: { enabled: true, mode: "x", overScaleMode: "x" },  // âœ… ë“œë˜ê·¸ë¡œ ê³¼ê±° ì´ë™
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: "x" }, // íœ /í•€ì¹˜ ì¤Œ
        },
      },
    },
  });
}

// ì£¼ê¸° ì‹¤í–‰
fetchGoldPrices();
setInterval(fetchGoldPrices, 600000); // 10ë¶„ë§ˆë‹¤
</script>
</body>
</html>
