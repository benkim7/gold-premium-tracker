<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>금 김치 프리미엄 추적기</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>금 김치 프리미엄 추이</h1>
  <div id="data"></div>
  <canvas id="chart" width="600" height="300"></canvas>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://ozatkbrmvkhejrbymrvd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96YXRrYnJtdmtoZWpyYnltcnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDMxNTUsImV4cCI6MjA3NTIxOTE1NX0.vxq7FyffhNJwMzoV1c8b6lI25n39X6Tud2oTAiICM5w";  // 반드시 anon public key
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function fetchGoldPrices() {
      try {
        // metals-api 호출 (URL 및 키 확인)
        const response = await fetch(
          `https://metalapi.com/api/v1/latest?api_key=6w0ly66tw8li4g0hp72mzukci0p1qnheg4o8t3wby5qprrkw3u8rd9lj5gyu&base=USD&symbols=XAU`
        );
        const json = await response.json();

        if (!json || !json.rates || typeof json.rates.XAU !== "number") {
          console.error("금 시세 API 응답 형식 오류:", json);
          return;
        }

        // metals-api의 rates.XAU는 “1 USD = XAU 단위 금” 비율일 수 있으니 역수 취해야 함
        const rateXAU = json.rates.XAU;
        const intlPriceUSD = 1 / rateXAU; // USD per ounce

        // 환율 가져오기
        const fxRes = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=KRW");
        const fxData = await fxRes.json();
        const usdToKrw = fxData.rates.KRW;
        const intlPriceKRW = intlPriceUSD * usdToKrw;

        // 임시 국내 가격 (나중에 실제 국내 금 시세 API로 교체)
        const korPrice = intlPriceKRW * (1 + (Math.random() * 0.05 - 0.02));
        const premium = ((korPrice - intlPriceKRW) / intlPriceKRW) * 100;

        // 화면 출력
        document.getElementById("data").innerHTML = `
          <p>국제 금 (USD/oz): ${intlPriceUSD.toFixed(2)}</p>
          <p>국제 금 (KRW 환산): ${intlPriceKRW.toLocaleString()}</p>
          <p>국내 금 시세(추정): ${korPrice.toLocaleString()}</p>
          <h2>김치 프리미엄: ${premium.toFixed(2)}%</h2>
        `;

        // Supabase 저장
        const { error: insertError } = await supabase
          .from("gold_prices")
          .insert([
            {
              intl_price_usd: intlPriceUSD,
              intl_price_krw: intlPriceKRW,
              kor_price_krw: korPrice,
              premium,
            },
          ]);
        if (insertError) {
          console.error("Supabase insert error:", insertError);
        }

        // 차트 불러오기
        loadChart();
      } catch (err) {
        console.error("fetchGoldPrices 에러:", err);
      }
    }

    async function loadChart() {
      const { data, error } = await supabase
        .from("gold_prices")
        .select("created_at,premium")
        .order("created_at", { ascending: true });

      if (error) {
        console.error("loadChart error:", error);
        return;
      }

      const labels = data.map(row => new Date(row.created_at).toLocaleString());
      const values = data.map(row => row.premium);

      const ctx = document.getElementById("chart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "김치 프리미엄 (%)",
              data: values,
              borderWidth: 2,
              borderColor: "gold",
              fill: false,
            },
          ],
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    fetchGoldPrices();
  </script>
</body>
</html>
