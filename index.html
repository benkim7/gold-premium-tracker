<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>금 김치 프리미엄 추적기</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>금 김치 프리미엄 추이</h1>
  <div id="data"></div>
  <canvas id="chart" width="600" height="300"></canvas>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // 🔹 여기에 너의 Supabase 정보 입력
    const supabaseUrl = "https://ozatkbrmvkhejrbymrvd.supabase.co";
    const supabaseKey = process.env.SUPABASE_KEY;
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function fetchGoldPrices() {
      try {
        const intlRes = await fetch("https://api.metals.live/v1/spot/gold");
        const intlData = await intlRes.json();
        const intlPriceUSD = intlData[0].gold;

        const fxRes = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=KRW");
        const fxData = await fxRes.json();
        const usdToKrw = fxData.rates.KRW;
        const intlPriceKRW = intlPriceUSD * usdToKrw;

        // 🔸 임시 국내 금 시세 (실제 API로 바꿀 수 있음)
        const korPrice = intlPriceKRW * (1 + Math.random() * 0.05 - 0.02);
        const premium = ((korPrice - intlPriceKRW) / intlPriceKRW) * 100;

        // 페이지 표시
        document.getElementById("data").innerHTML = `
          <p>국제 금: ${intlPriceUSD.toFixed(2)} USD/oz</p>
          <p>국제 금(원화): ${intlPriceKRW.toLocaleString()} KRW/oz</p>
          <p>국내 금 시세(추정): ${korPrice.toLocaleString()} KRW/oz</p>
          <h2>김치 프리미엄: ${premium.toFixed(2)}%</h2>
        `;

        // Supabase에 저장
        await supabase.from("gold_prices").insert([
          {
            intl_price_usd: intlPriceUSD,
            intl_price_krw: intlPriceKRW,
            kor_price_krw: korPrice,
            premium,
          },
        ]);

        // 차트 불러오기
        loadChart();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadChart() {
      const { data, error } = await supabase
        .from("gold_prices")
        .select("created_at, premium")
        .order("created_at", { ascending: true });

      const labels = data.map(row => new Date(row.created_at).toLocaleDateString());
      const values = data.map(row => row.premium);

      const ctx = document.getElementById("chart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "김치 프리미엄 (%)",
              data: values,
              borderWidth: 2,
              borderColor: "gold",
              fill: false,
            },
          ],
        },
        options: {
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    fetchGoldPrices();
  </script>
</body>
</html>
