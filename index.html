<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì ê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; text-align: center; margin: 20px; background-color: #fafafa; }
    h1 { margin-bottom: 10px; }
    #chart-container, #fx-chart-container {
      width: 100%; height: 60vh; margin-bottom: 40px;
      overflow-x: auto; overflow-y: hidden;
    }
    canvas { width: 100%; height: 100%; }
    #footer { font-size: 11px; color: gray; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì´</h1>
  <div id="data"></div>

  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>

  <h2>í™˜ìœ¨ ì¶”ì´ (USD â†’ KRW)</h2>
  <div id="fx-chart-container">
    <canvas id="fxChart"></canvas>
  </div>

  <div id="footer">
    ğŸ“Š ë°ì´í„° ì¶œì²˜:
    <a href="https://metals-api.com" target="_blank">Metals API (êµ­ì œ ê¸ˆ)</a>,
    <a href="https://open.er-api.com" target="_blank">Open ER API (í™˜ìœ¨)</a>,
    <a href="https://apiportal.koreainvestment.com" target="_blank">í•œêµ­íˆ¬ìì¦ê¶Œ (êµ­ë‚´ ê¸ˆ)</a>
  </div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = "https://ozatkbrmvkhejrbymrvd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96YXRrYnJtdmtoZWpyYnltcnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDMxNTUsImV4cCI6MjA3NTIxOTE1NX0.vxq7FyffhNJwMzoV1c8b6lI25n39X6Tud2oTAiICM5w";
const supabase = createClient(supabaseUrl, supabaseKey);

const METALS_KEY = "6w0ly66tw8li4g0hp72mzukci0p1qnheg4o8t3wby5qprrkw3u8rd9lj5gyu";
let goldChart, fxChart;

async function fetchGoldPrices() {
  try {
    // 1ï¸âƒ£ êµ­ì œ ê¸ˆ ì‹œì„¸ (USD/oz)
    const mResp = await fetch(`https://metals-api.com/api/latest?access_key=${METALS_KEY}&base=USD&symbols=XAU`);
    const mJson = await mResp.json();
    if (!mJson.success) throw new Error("Metals API ì˜¤ë¥˜: " + JSON.stringify(mJson));
    const intlPriceUSD = 1 / mJson.rates.XAU;

    // 2ï¸âƒ£ í™˜ìœ¨ (USDâ†’KRW)
    const fxResp = await fetch("https://open.er-api.com/v6/latest/USD");
    const fxJson = await fxResp.json();
    const usdToKrw = fxJson?.rates?.KRW ?? fxJson?.conversion_rates?.KRW;
    if (!usdToKrw) throw new Error("í™˜ìœ¨ ë°ì´í„° ì—†ìŒ");
    const intlPriceKRW = intlPriceUSD * usdToKrw;

    // 3ï¸âƒ£ êµ­ë‚´ ê¸ˆ ì‹œì„¸ (í”„ë¡ì‹œ)
    let korPriceKRWPerOz = intlPriceKRW;
    try {
      const kisResp = await fetch("/api/kis-goldprice");
      const kisJson = await kisResp.json();
      if (kisResp.ok && kisJson?.ok && kisJson.priceKRWPerOz > 0) {
        korPriceKRWPerOz = kisJson.priceKRWPerOz;
      } else {
        console.warn("êµ­ë‚´ ê¸ˆ ì‹œì„¸ ì—†ìŒ, êµ­ì œ ì‹œì„¸ë¡œ ëŒ€ì²´");
      }
    } catch (err) {
      console.warn("KIS í”„ë¡ì‹œ í˜¸ì¶œ ì‹¤íŒ¨:", err);
    }

    // 4ï¸âƒ£ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ê³„ì‚°
    const premium = ((korPriceKRWPerOz - intlPriceKRW) / intlPriceKRW) * 100;

    // 5ï¸âƒ£ Supabaseì— ì €ì¥
    await supabase.from("gold_prices").insert([
      {
        intl_price_usd: intlPriceUSD,
        intl_price_krw: intlPriceKRW,
        kor_price_krw: korPriceKRWPerOz,
        usd_to_krw: usdToKrw,
        premium,
      },
    ]);

    // 6ï¸âƒ£ í™”ë©´ í‘œì‹œ
    const nowKST = new Date(Date.now() + 9 * 60 * 60 * 1000);
    document.getElementById("data").innerHTML = `
      <p>ğŸ•’ ê¸°ì¤€ì‹œê° (KST): ${nowKST.toLocaleString("ko-KR")}</p>
      <p>êµ­ì œ ê¸ˆ (USD/oz):
