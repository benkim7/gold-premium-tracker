<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>금 김치 프리미엄 추적기</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>금 김치 프리미엄 추이</h1>
  <div id="data"></div>
  <canvas id="chart" width="600" height="300"></canvas>

  <script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Supabase (네 값 유지)
  const supabaseUrl = "https://ozatkbrmvkhejrbymrvd.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96YXRrYnJtdmtoZWpyYnltcnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDMxNTUsImV4cCI6MjA3NTIxOTE1NX0.vxq7FyffhNJwMzoV1c8b6lI25n39X6Tud2oTAiICM5w";
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Metals-API 키 (이미 쓰던 값 그대로)
  const METALS_KEY = "6w0ly66tw8li4g0hp72mzukci0p1qnheg4o8t3wby5qprrkw3u8rd9lj5gyu";

  let chart; // 차트 중복 생성 방지용

  async function fetchGoldPrices() {
    try {
      // 1) 국제 금 시세 (USD/oz)
      const mUrl = `https://metals-api.com/api/latest?access_key=${METALS_KEY}&base=USD&symbols=XAU`;
      const mResp = await fetch(mUrl);
      const mJson = await mResp.json();
      if (!mResp.ok || !mJson?.success) {
        throw new Error("metals-api 오류: " + JSON.stringify(mJson));
      }
      // 응답에 USDXAU가 있으면 그대로 사용, 없으면 1/rates.XAU
      const intlPriceUSD =
        typeof mJson.rates?.USDXAU === "number"
          ? mJson.rates.USDXAU
          : 1 / mJson.rates.XAU; // USD per XAU(=troy oz)

      // 2) 환율 (USD→KRW) — 키 불필요, CORS 허용
      const fxResp = await fetch("https://open.er-api.com/v6/latest/USD");
      const fxJson = await fxResp.json();
      const usdToKrw = fxJson?.rates?.KRW ?? fxJson?.conversion_rates?.KRW;
      if (fxJson?.result !== "success" || typeof usdToKrw !== "number") {
        throw new Error("환율 응답 오류: " + JSON.stringify(fxJson));
      }

      // 3) KRW/oz 환산
      const intlPriceKRW = intlPriceUSD * usdToKrw;

      // 4) (임시) 국내 금 시세 — 실제 API로 교체 예정
      const korPrice = intlPriceKRW * (1 + (Math.random() * 0.05 - 0.02)); // ±2~5%
      const premium = ((korPrice - intlPriceKRW) / intlPriceKRW) * 100;

      // 5) 화면 표시
      document.getElementById("data").innerHTML = `
        <p>국제 금 (USD/oz): ${intlPriceUSD.toFixed(2)}</p>
        <p>국제 금 (KRW/oz): ${intlPriceKRW.toLocaleString()}</p>
        <p>국내 금 (임시 KRW/oz): ${korPrice.toLocaleString()}</p>
        <h2>김치 프리미엄: ${premium.toFixed(2)}%</h2>
      `;

      // 6) Supabase 저장
      const { error: insertError } = await supabase
        .from("gold_prices")
        .insert([
          {
            intl_price_usd: intlPriceUSD,
            intl_price_krw: intlPriceKRW,
            kor_price_krw: korPrice,
            premium,
          },
        ]);
      if (insertError) console.error("Supabase insert error:", insertError);

      // 7) 차트 렌더(중복 생성 방지)
      await loadChart();
    } catch (err) {
      console.error("fetchGoldPrices 에러:", err);
      document.getElementById("data").innerHTML =
        `<p style="color:red">에러: ${String(err.message || err)}</p>`;
    }
  }

  async function loadChart() {
    const { data, error } = await supabase
      .from("gold_prices")
      .select("created_at,premium")
      .order("created_at", { ascending: true })
      .limit(1000);

    if (error || !data || data.length === 0) return;

    const labels = data.map(r => new Date(r.created_at).toLocaleString());
    const values = data.map(r => r.premium);

    const ctx = document.getElementById("chart").getContext("2d");
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "김치 프리미엄 (%)",
          data: values,
          borderWidth: 2,
          borderColor: "gold",
          fill: false
        }],
      },
      options: { scales: { y: { beginAtZero: true } } },
    });
  }

  fetchGoldPrices();
</script>



</body>
</html>
