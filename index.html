<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì ê¸°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì´</h1>
  <div id="data"></div>
  <canvas id="chart" width="600" height="300"></canvas>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ğŸ”¹ ì—¬ê¸°ì— ë„ˆì˜ Supabase ì •ë³´ ì…ë ¥
    const supabaseUrl = "https://ozatkbrmvkhejrbymrvd.supabase.co";
    const supabaseKey = process.env.SUPABASE_KEY;
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function fetchGoldPrices() {
      try {
        const intlRes = await fetch("https://api.metals.live/v1/spot/gold");
        const intlData = await intlRes.json();
        const intlPriceUSD = intlData[0].gold;

        const fxRes = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=KRW");
        const fxData = await fxRes.json();
        const usdToKrw = fxData.rates.KRW;
        const intlPriceKRW = intlPriceUSD * usdToKrw;

        // ğŸ”¸ ì„ì‹œ êµ­ë‚´ ê¸ˆ ì‹œì„¸ (ì‹¤ì œ APIë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ)
        const korPrice = intlPriceKRW * (1 + Math.random() * 0.05 - 0.02);
        const premium = ((korPrice - intlPriceKRW) / intlPriceKRW) * 100;

        // í˜ì´ì§€ í‘œì‹œ
        document.getElementById("data").innerHTML = `
          <p>êµ­ì œ ê¸ˆ: ${intlPriceUSD.toFixed(2)} USD/oz</p>
          <p>êµ­ì œ ê¸ˆ(ì›í™”): ${intlPriceKRW.toLocaleString()} KRW/oz</p>
          <p>êµ­ë‚´ ê¸ˆ ì‹œì„¸(ì¶”ì •): ${korPrice.toLocaleString()} KRW/oz</p>
          <h2>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„: ${premium.toFixed(2)}%</h2>
        `;

        // Supabaseì— ì €ì¥
        await supabase.from("gold_prices").insert([
          {
            intl_price_usd: intlPriceUSD,
            intl_price_krw: intlPriceKRW,
            kor_price_krw: korPrice,
            premium,
          },
        ]);

        // ì°¨íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        loadChart();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadChart() {
      const { data, error } = await supabase
        .from("gold_prices")
        .select("created_at, premium")
        .order("created_at", { ascending: true });

      const labels = data.map(row => new Date(row.created_at).toLocaleDateString());
      const values = data.map(row => row.premium);

      const ctx = document.getElementById("chart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ (%)",
              data: values,
              borderWidth: 2,
              borderColor: "gold",
              fill: false,
            },
          ],
        },
        options: {
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    fetchGoldPrices();
  </script>
</body>
</html>
