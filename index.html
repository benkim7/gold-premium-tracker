<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>금 김치 프리미엄 추적기</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>금 김치 프리미엄 추이</h1>
  <div id="data"></div>
  <canvas id="chart" width="600" height="300"></canvas>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Supabase (이미 만든 anon 키 그대로 사용)
  const supabaseUrl = "https://ozatkbrmvkhejrbymrvd.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96YXRrYnJtdmtoZWpyYnltcnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDMxNTUsImV4cCI6MjA3NTIxOTE1NX0.vxq7FyffhNJwMzoV1c8b6lI25n39X6Tud2oTAiICM5w"; // 현재 사용 중인 anon 키 그대로
  const supabase = createClient(supabaseUrl, supabaseKey);

  async function fetchGoldPrices() {
    try {
      // 1) 금 시세(USD/oz) - 키 불필요, CORS 허용
      //    1 XAU = 1 트로이온스 금
      const goldRes = await fetch("https://api.exchangerate.host/convert?from=XAU&to=USD");
      const goldJson = await goldRes.json();
      if (!goldJson?.success || typeof goldJson.result !== "number") {
        throw new Error("XAU→USD 응답 오류: " + JSON.stringify(goldJson));
      }
      const intlPriceUSD = goldJson.result; // USD per XAU(oz)

      // 2) 환율(USD→KRW)
      const fxRes = await fetch("https://api.exchangerate.host/convert?from=USD&to=KRW");
      const fxJson = await fxRes.json();
      if (!fxJson?.success || typeof fxJson.result !== "number") {
        throw new Error("USD→KRW 응답 오류: " + JSON.stringify(fxJson));
      }
      const usdToKrw = fxJson.result;

      // 3) 국제 금 원화 환산
      const intlPriceKRW = intlPriceUSD * usdToKrw;

      // 4) (임시) 국내 금 시세: 실제 API 붙이기 전까지는 추정치로 표시
      //    KRX/한국금거래소 API 붙이면 이 값만 교체하면 됩니다.
      const korPrice = intlPriceKRW * (1 + (Math.random() * 0.05 - 0.02));
      const premium = ((korPrice - intlPriceKRW) / intlPriceKRW) * 100;

      // 5) 화면 표시
      document.getElementById("data").innerHTML = `
        <p>국제 금 (USD/oz): ${intlPriceUSD.toFixed(2)}</p>
        <p>국제 금 (KRW/oz): ${intlPriceKRW.toLocaleString()}</p>
        <p>국내 금 (추정 KRW/oz): ${korPrice.toLocaleString()}</p>
        <h2>김치 프리미엄: ${premium.toFixed(2)}%</h2>
      `;

      // 6) Supabase 저장
      const { error: insertError } = await supabase
        .from("gold_prices")
        .insert([{ intl_price_usd: intlPriceUSD, intl_price_krw: intlPriceKRW, kor_price_krw: korPrice, premium }]);
      if (insertError) console.error("Supabase insert error:", insertError);

      // 7) 차트 렌더
      await loadChart();
    } catch (err) {
      console.error("fetchGoldPrices 에러:", err);
      document.getElementById("data").innerHTML = `<p style="color:red">에러: ${String(err)}</p>`;
    }
  }

  async function loadChart() {
    const { data, error } = await supabase
      .from("gold_prices")
      .select("created_at,premium")
      .order("created_at", { ascending: true })
      .limit(1000);

    if (error) {
      console.error("loadChart error:", error);
      return;
    }
    if (!data || data.length === 0) return;

    const labels = data.map(r => new Date(r.created_at).toLocaleString());
    const values = data.map(r => r.premium);

    const ctx = document.getElementById("chart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{ label: "김치 프리미엄 (%)", data: values, borderWidth: 2, borderColor: "gold", fill: false }],
      },
      options: { scales: { y: { beginAtZero: true } } },
    });
  }

  fetchGoldPrices();
</script>

</body>
</html>
