<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì ê¸°</title>
  <!-- Chart.js + time ì–´ëŒ‘í„° + ì¤Œ í”ŒëŸ¬ê·¸ì¸ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; text-align: center; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 8px; }
    #data { margin-bottom: 12px; }
    /* ìŠ¤í¬ë¡¤ë°”ê°€ ë³´ì´ë„ë¡ ì»¨í…Œì´ë„ˆëŠ” ê³ ì •í­, ìº”ë²„ìŠ¤ëŠ” ì½”ë“œì—ì„œ ë” ë„“ê²Œ ê·¸ë¦½ë‹ˆë‹¤ */
    .chart-wrap { width: 100%; height: 60vh; overflow-x: auto; overflow-y: hidden; border-radius: 8px; background:#fff; box-shadow: 0 2px 8px rgba(0,0,0,.05); margin-bottom: 28px; }
    canvas { height: 100%; } /* widthëŠ” JSì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì • */
    #footer { font-size: 11px; color: gray; }
  </style>
</head>
<body>
  <h1>ê¸ˆ ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ ì¶”ì´</h1>
  <div id="data"></div>

  <div class="chart-wrap"><canvas id="goldChart"></canvas></div>
  <h2 style="margin:0 0 8px">í™˜ìœ¨ ì¶”ì´ (USDâ†’KRW)</h2>
  <div class="chart-wrap" style="height:42vh"><canvas id="fxChart"></canvas></div>

  <div id="footer">
    ğŸ“Š ë°ì´í„° ì¶œì²˜:
    <a href="https://metals-api.com" target="_blank">Metals API (êµ­ì œ ê¸ˆ)</a>,
    <a href="https://open.er-api.com" target="_blank">Open ER API (í™˜ìœ¨)</a>,
    <a href="https://apiportal.koreainvestment.com" target="_blank">í•œêµ­íˆ¬ìì¦ê¶Œ (êµ­ë‚´ ê¸ˆ)</a>
  </div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabase = createClient(
  "https://ozatkbrmvkhejrbymrvd.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96YXRrYnJtdmtoZWpyYnltcnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NDMxNTUsImV4cCI6MjA3NTIxOTE1NX0.vxq7FyffhNJwMzoV1c8b6lI25n39X6Tud2oTAiICM5w"
);
const METALS_KEY = "6w0ly66tw8li4g0hp72mzukci0p1qnheg4o8t3wby5qprrkw3u8rd9lj5gyu";

let goldChart, fxChart;

// ìœ í‹¸
const toKST = msUTC => new Date(msUTC + 9*60*60*1000);
const fmtUSD = x => Number(x).toLocaleString("en-US", { maximumFractionDigits: 2 });
const fmtKRW = x => Number(x).toLocaleString("ko-KR");

// ë©”ì¸ ìˆ˜ì§‘ + ì €ì¥ + ë Œë”
async function fetchGoldPrices() {
  try {
    // 1) êµ­ì œ ê¸ˆ (USD/oz) - Metals API (10ë¶„ ì—…ë°ì´íŠ¸)
    const mResp = await fetch(`https://metals-api.com/api/latest?access_key=${METALS_KEY}&base=USD&symbols=XAU`);
    const mJson = await mResp.json();
    if (!mJson.success) throw new Error("Metals API ì˜¤ë¥˜: " + JSON.stringify(mJson));
    const intlPriceUSD = 1 / mJson.rates.XAU; // USD/oz
    const lastUpdateKST = toKST(mJson.timestamp*1000).toLocaleString("ko-KR");

    // 2) í™˜ìœ¨ (USDâ†’KRW)
    const fxResp = await fetch("https://open.er-api.com/v6/latest/USD");
    const fxJson = await fxResp.json();
    const usdToKrw = fxJson?.rates?.KRW ?? fxJson?.conversion_rates?.KRW;
    if (typeof usdToKrw !== "number") throw new Error("í™˜ìœ¨ ì‘ë‹µ ì˜¤ë¥˜");
    const intlPriceKRW = intlPriceUSD * usdToKrw; // KRW/oz

    // 3) êµ­ë‚´ ê¸ˆ (KIS í”„ë¡ì‹œ, ë‹¨ìœ„: KRW/oz)
    let korPriceKRWPerOz = intlPriceKRW;
    try {
      const kisResp = await fetch("/api/kis-goldprice");
      const kisJson = await kisResp.json();
      if (kisResp.ok && kisJson?.ok && typeof kisJson.priceKRWPerOz === "number" && kisJson.priceKRWPerOz > 0) {
        korPriceKRWPerOz = kisJson.priceKRWPerOz;
      }
    } catch (_) { /* fallback ìœ ì§€ */ }

    // 4) í”„ë¦¬ë¯¸ì—„
    const premium = ((korPriceKRWPerOz - intlPriceKRW) / intlPriceKRW) * 100;

    // 5) DB ì €ì¥ (ì‹¤íŒ¨ ì‹œ í™”ë©´ì—ë„ í‘œì‹œ)
    const { error: insertError } = await supabase.from("gold_prices").insert([{
      intl_price_usd: intlPriceUSD,   // âœ… USD/oz ì €ì¥ (ìš”ì²­í•˜ì‹  ëŒ€ë¡œ)
      intl_price_krw: intlPriceKRW,   // KRW/oz
      kor_price_krw:  korPriceKRWPerOz,
      usd_to_krw:     usdToKrw,
      premium,
    }]);
    if (insertError) throw insertError;

    // ìƒë‹¨ ì •ë³´
    document.getElementById("data").innerHTML = `
      <p>ğŸ•’ ìµœê·¼ ì—…ë°ì´íŠ¸(KST): ${lastUpdateKST}</p>
      <p>ğŸŒ êµ­ì œ ê¸ˆ (USD/oz): ${fmtUSD(intlPriceUSD)}</p>
      <p>ğŸŒ êµ­ì œ ê¸ˆ (KRW/oz): ${fmtKRW(intlPriceKRW)}</p>
      <p>ğŸ‡°ğŸ‡· êµ­ë‚´ ê¸ˆ (KRW/oz): ${fmtKRW(korPriceKRWPerOz)}</p>
      <p>ğŸ’± í™˜ìœ¨: ${fmtKRW(usdToKrw)} KRW/USD</p>
      <h2>ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„: ${premium.toFixed(2)}%</h2>
    `;

    await renderGoldChart();
    await renderFxChart();

  } catch (err) {
    console.error("fetchGoldPrices error:", err);
    document.getElementById("data").innerHTML =
      `<p style="color:#b00020">ì˜¤ë¥˜: ${err.message || err}</p>`;
  }
}

// ì°¨íŠ¸ 1: êµ­ì œ(USD/oz, ë…¸ë€ ë§‰ëŒ€) + êµ­ë‚´(KRW/oz, íŒŒë€ ë§‰ëŒ€) + í”„ë¦¬ë¯¸ì—„(%) ì„ 
async function renderGoldChart() {
  const { data, error } = await supabase
    .from("gold_prices")
    .select("created_at,intl_price_usd,kor_price_krw,premium")
    .order("created_at", { ascending: true });

  if (error || !data || !data.length) return;

  // time scaleìš© í¬ì¸íŠ¸ (UTC â†’ KST ë³´ì •)
  const ptsUSD = data.map(r => ({ x: toKST(Date.parse(r.created_at)), y: r.intl_price_usd }));   // USD/oz
  const ptsKRW = data.map(r => ({ x: toKST(Date.parse(r.created_at)), y: r.kor_price_krw }));    // KRW/oz
  const ptsPct = data.map(r => ({ x: toKST(Date.parse(r.created_at)), y: r.premium }));          // %

  // âœ… ìŠ¤í¬ë¡¤ë°” ë§Œë“¤ê¸°: ìº”ë²„ìŠ¤ í­ì„ ë°ì´í„° ê°œìˆ˜ì— ë¹„ë¡€í•´ í¬ê²Œ
  const pxPerPoint = 40; // ë°ì´í„° 1ê°œë‹¹ ê°€ë¡œ í”½ì…€
  const canvas = document.getElementById("goldChart");
  canvas.width  = Math.max(900, ptsUSD.length * pxPerPoint);
  canvas.height = 480;

  if (goldChart) goldChart.destroy();
  goldChart = new Chart(canvas.getContext("2d"), {
    type: "bar",
    data: {
      datasets: [
        { label: "êµ­ì œ ê¸ˆ (USD/oz)", data: ptsUSD, backgroundColor: "rgba(255, 215, 0, 0.65)", yAxisID: "yUSD" },
        { label: "êµ­ë‚´ ê¸ˆ (KRW/oz)", data: ptsKRW, backgroundColor: "rgba(30, 144, 255, 0.45)", yAxisID: "yKRW" },
        { type: "line", label: "ê¹€ì¹˜ í”„ë¦¬ë¯¸ì—„ (%)", data: ptsPct, borderColor: "red", borderWidth: 2, fill: false, yAxisID: "yPct" },
      ],
    },
    options: {
      parsing: false,           // {x,y} ê·¸ëŒ€ë¡œ ì‚¬ìš©
      responsive: false,        // âœ… ìº”ë²„ìŠ¤ widthë¥¼ ìš°ë¦¬ê°€ ì§ì ‘ ì œì–´(ìŠ¤í¬ë¡¤ë°”)
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: {
          type: "time",
          time: { unit: "minute", displayFormats: { minute: "MM-dd HH:mm" } },
          title: { display: true, text: "ì‹œê°„ (KST)" },
        },
        yUSD: {                  // ì™¼ìª½: USD/oz (ë…¸ë€ ë§‰ëŒ€)
          position: "left",
          title: { display: true, text: "USD/oz" },
        },
        yKRW: {                  // ì˜¤ë¥¸ìª½: KRW/oz (íŒŒë€ ë§‰ëŒ€)
          position: "right",
          title: { display: true, text: "KRW/oz" },
          grid: { drawOnChartArea: false },
        },
        yPct: {                  // ì˜¤ë¥¸ìª½ ë³´ì¡°ì¶•: %
          position: "right",
          title: { display: true, text: "í”„ë¦¬ë¯¸ì—„ (%)" },
          grid: { drawOnChartArea: false },
          offset: true
        },
      },
      plugins: {
        legend: { position: "bottom" },
        zoom: {
          pan:  { enabled: true, mode: "x" },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, drag: { enabled: true }, scaleMode: "x" }, // âœ… ìµœì‹  ì˜µì…˜ëª…
        },
      },
    },
  });
}

// ì°¨íŠ¸ 2: í™˜ìœ¨
async function renderFxChart() {
  const { data, error } = await supabase
    .from("gold_prices")
    .select("created_at,usd_to_krw")
    .order("created_at", { ascending: true });

  if (error || !data || !data.length) return;

  const ptsFx = data.map(r => ({ x: toKST(Date.parse(r.created_at)), y: r.usd_to_krw }));

  const canvas = document.getElementById("fxChart");
  const pxPerPoint = 30;
  canvas.width  = Math.max(900, ptsFx.length * pxPerPoint);
  canvas.height = 360;

  if (fxChart) fxChart.destroy();
  fxChart = new Chart(canvas.getContext("2d"), {
    type: "line",
    data: { datasets: [{ label: "KRW/USD", data: ptsFx, borderColor: "blue", borderWidth: 2, fill: false }] },
    options: {
      parsing: false,
      responsive: false,        // âœ… ìŠ¤í¬ë¡¤ë°” ìœ„í•œ ê³ ì •í­
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: { type: "time", time: { unit: "minute", displayFormats: { minute: "MM-dd HH:mm" } }, title: { display: true, text: "ì‹œê°„ (KST)" } },
        y: { title: { display: true, text: "í™˜ìœ¨ (KRW/USD)" }, beginAtZero: false },
      },
      plugins: {
        legend: { position: "bottom" },
        zoom: { pan: { enabled: true, mode: "x" }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, drag: { enabled: true }, scaleMode: "x" } },
      },
    },
  });
}

// 10ë¶„ ê°„ê²© ìˆ˜ì§‘
fetchGoldPrices();
setInterval(fetchGoldPrices, 600000);
</script>
</body>
</html>
